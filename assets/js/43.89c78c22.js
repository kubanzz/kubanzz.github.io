(window.webpackJsonp=window.webpackJsonp||[]).push([[43],{370:function(s,n,e){"use strict";e.r(n);var t=e(12),a=Object(t.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"springcloud整合websocket"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#springcloud整合websocket"}},[s._v("#")]),s._v(" SpringCloud整合WebSocket")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://blog.csdn.net/moshowgame/article/details/80275084",target:"_blank",rel:"noopener noreferrer"}},[s._v("参考"),n("OutboundLink")],1)])]),s._v(" "),n("h2",{attrs:{id:"个人探索版"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#个人探索版"}},[s._v("#")]),s._v(" 个人探索版")]),s._v(" "),n("p",[s._v("整合websocket可能遇到的问题：")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("功能上：可行")]),s._v(" "),n("ul",[n("li",[s._v("什么时候主动推送事件？如果是有事件进来的时候推送，是触发的时候去数据库（存在事件还没有插入数据库的问题）？如果不是查数据库而是直接推给前端，则只能单独发送一条，所以未读信息需要前端维护。")])])]),s._v(" "),n("li",[n("p",[s._v("技术上：")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("如何经过网关建立websocket？")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://cloud.spring.io/spring-cloud-gateway/reference/html/",target:"_blank",rel:"noopener noreferrer"}},[s._v("参考"),n("OutboundLink")],1)]),s._v(" "),n("li",[s._v("解决：直接可以通过spring cloud gateway负载到服务器上，看官方文档非常重要！找了一堆技术文章，还不如直接去看gateway官方文档，立马解决。")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('service:\n  uri:\n\tws-svc: lb:ws://ws-service\n\n@Value("${service.uri.ws-svc}")\nprivate String websocketSvcUri;\n\n@Bean\npublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) {\n\n        return builder.routes()\n                .route(r -> r.path("/ws-svc/**")\n                        .filters(f -> f.rewritePath("/ws-svc/(?<path>.*)","/${path}"))\n                        .uri(websocketSvcUri)\n                )\n                .build();\n    }\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("单体服务直接连接某台服务器的websocket，分布式环境下会导致服务的其他节点无法连接websocket，从而导致消息丢失。")]),s._v(" "),n("ul",[n("li",[s._v("解决：独立部署ws服务（否则每次新建ws，都得更改gateway route，而且这样方便ws维护和横向扩展），由ws服务跟客户端建立连接并通过dubbo暴露消息发送的方法，由其他服务调用ws进行主动发送，解决服务多实例问题（dubbo调用也可以用MQ替换）")])])]),s._v(" "),n("li",[n("p",[s._v("如果websocket遇到性能瓶颈，横向扩展后如何共享ws session？")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://juejin.cn/post/6844903584929153032",target:"_blank",rel:"noopener noreferrer"}},[s._v("参考"),n("OutboundLink")],1)]),s._v(" "),n("li",[s._v("解决：通过redis进行session共享，但是ws session网上说是有序列化问题，我还需要验证一下。")])])])])])]),s._v(" "),n("h2",{attrs:{id:"同事版"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#同事版"}},[s._v("#")]),s._v(" 同事版")]),s._v(" "),n("blockquote",[n("p",[s._v("相比于我个人探索的版本，同事这边的代码就比较完善，利用到了拦截器并做了分组件封装，而且他发送websocket的思路不太一样，我原本是想每个需要主动推送的地方都需要有单独的websocket endpoint，而他是只用一个endpoint去发送多个地方的websocket，通过一个字段进行确定这个websocket是显示在哪个模块的，好处是代码量减少，代码通用性变强，对于同个用户，可以避免创建大量websocket连接。")])]),s._v(" "),n("p",[n("strong",[s._v("HttpAuthHandler")])]),s._v(" "),n("blockquote",[n("p",[s._v("该类作为建立连接、断开连接、发送文本时的钩子")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Component\npublic class HttpAuthHandler extends TextWebSocketHandler {\n    static Logger logger = LoggerFactory.getLogger(HttpAuthHandler.class);\n    @Override\n    public void afterConnectionEstablished(WebSocketSession session) throws Exception {\n\n        Object token = session.getAttributes().get("token");\n        if (token != null) {\n            // 用户连接成功，放入在线用户缓存\n            WsSessionManager.add(token.toString(), session);\n        } else {\n            throw new RuntimeException("用户登录已经失效!");\n        }\n    }\n\n    @Override\n    protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception {\n        String payload = message.getPayload();\n        Object token = session.getAttributes().get("token");\n        logger.info("server 接收到 " + token + " 发送的 " + payload);\n        session.sendMessage(new TextMessage("server 发送给 " + token + " 消息 " + payload + " " + LocalDateTime.now().toString()));\n    }\n\n    @Override\n    public void afterConnectionClosed(WebSocketSession session, CloseStatus status) throws Exception {\n        Object token = session.getAttributes().get("token");\n        if (token != null) {\n            // 用户退出，移除缓存\n            logger.info("websocket 用户退出:" + token);\n            WsSessionManager.remove(token.toString());\n        }\n    }\n}\n\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br")])]),n("p",[n("strong",[s._v("MyInterceptor")])]),s._v(" "),n("blockquote",[n("p",[s._v("该类作为websocket握手前和握手后的钩子")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Component\npublic class MyInterceptor implements HandshakeInterceptor {\n\n    static Logger logger = LoggerFactory.getLogger(MyInterceptor.class);\n\n    @Override\n    public boolean beforeHandshake(ServerHttpRequest serverHttpRequest, ServerHttpResponse serverHttpResponse, WebSocketHandler webSocketHandler, Map<String, Object> map) throws Exception {\n        String hostName = serverHttpRequest.getLocalAddress().getHostName();\n        logger.info("websocket 开始握手" + hostName);\n        String uuid = UUID.randomUUID().toString();\n        logger.info("随机uuid:"+uuid);\n        map.put("token",uuid);\n        return true;\n    }\n\n    @Override\n    public void afterHandshake(ServerHttpRequest serverHttpRequest, ServerHttpResponse serverHttpResponse, WebSocketHandler webSocketHandler, Exception e) {\n        logger.info("握手完成");\n\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("p",[n("strong",[s._v("WebSocketConfig")])]),s._v(" "),n("blockquote",[n("p",[s._v("该类作为websocket的核心配置类，注册websocket endpoint并注入前面的两个钩子类")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Configuration\n@EnableWebSocket\npublic class WebSocketConfig implements WebSocketConfigurer {\n\n    @Autowired\n    private HttpAuthHandler httpAuthHandler;\n\n    @Autowired\n    private MyInterceptor myInterceptor;\n\n    @Override\n    public void registerWebSocketHandlers(WebSocketHandlerRegistry webSocketHandlerRegistry) {\n        webSocketHandlerRegistry\n                .addHandler(httpAuthHandler,"/websocket")\n                .addInterceptors(myInterceptor)\n                .setAllowedOrigins("*");\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[n("strong",[s._v("WsSessionManager")])]),s._v(" "),n("blockquote",[n("p",[s._v("该类用于管理websocket的session，以及向所有session连接的用户发送消息")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("public class WsSessionManager {\n    private static ConcurrentHashMap<String, WebSocketSession> SESSION_POOL = new ConcurrentHashMap<>();\n\n    /**\n     * 添加 session\n     *\n     * @param key\n     */\n    public static void add(String key, WebSocketSession session) {\n        // 添加 session\n        SESSION_POOL.put(key, session);\n    }\n\n    /**\n     * 删除 session,会返回删除的 session\n     *\n     * @param key\n     * @return\n     */\n    public static WebSocketSession remove(String key) {\n        // 删除 session\n        return SESSION_POOL.remove(key);\n    }\n\n    /**\n     * 删除并同步关闭连接\n     *\n     * @param key\n     */\n    public static void removeAndClose(String key) {\n        WebSocketSession session = remove(key);\n        if (session != null) {\n            try {\n                // 关闭连接\n                session.close();\n            } catch (IOException e) {\n                // todo: 关闭出现异常处理\n                e.printStackTrace();\n            }\n        }\n    }\n\n    /**\n     * 获得 session\n     *\n     * @param key\n     * @return\n     */\n    public static WebSocketSession get(String key) {\n        // 获得 session\n        return SESSION_POOL.get(key);\n    }\n\n    public synchronized static void sendMessage(String json) {\n        TextMessage textMessage = new TextMessage(json);\n        try {\n            for (WebSocketSession session : SESSION_POOL.values()) {\n                session.sendMessage(textMessage);\n            }\n        }catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br")])])])}),[],!1,null,null,null);n.default=a.exports}}]);